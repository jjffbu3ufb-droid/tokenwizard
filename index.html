<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat with ChatGPT — Auth Gated</title>
<style>
  body{margin:0;font-family:sans-serif;background:#0b1020;color:#e9ecf1;min-height:100vh}
  .wrap{max-width:900px;margin:auto;padding:16px;display:grid;grid-template-columns:300px 1fr;gap:12px}
  @media(max-width:800px){.wrap{grid-template-columns:1fr}}
  label{display:block;margin-top:10px;font-size:12px;color:#b6bed3}
  textarea,select,button,input{width:100%;border-radius:8px;border:1px solid #444;background:#0e1530;color:#e9ecf1;padding:10px}
  textarea{min-height:100px;resize:vertical}
  .log{border:1px solid #333;border-radius:8px;padding:10px;max-height:60vh;overflow:auto;white-space:pre-wrap}
  .msg{padding:8px;margin:6px 0;border-radius:8px}
  .user{background:#0f1a3f;align-self:flex-end}
  .assistant{background:#1a1f3f}
  .row{display:flex;gap:8px;align-items:center}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#12204a;border:1px solid #243056;font-size:12px;color:#c8d1e7}
  details{margin-top:8px}
  summary{cursor:pointer;color:#c8d1e7}
</style>
</head>
<body>
<h1 style="text-align:center">Chat with ChatGPT</h1>

<div class="wrap">
  <section>
    <!-- AUTH UI -->
    <div style="margin-bottom:14px">
      <div class="row" style="justify-content:space-between;gap:12px">
        <button id="googleBtn" type="button" style="flex:1">Sign in with Google</button>
        <button id="signOutBtn" type="button" style="flex:0.6;display:none">Sign out</button>
      </div>

      <details id="emailBox">
        <summary>Email sign in / create account</summary>
        <div style="margin-top:8px;display:grid;gap:8px">
          <input id="email" type="email" placeholder="email@example.com" autocomplete="email" />
          <input id="password" type="password" placeholder="Password (min 6 chars)" autocomplete="current-password" />
          <div class="row">
            <button id="emailSignInBtn" type="button">Sign in</button>
            <button id="emailCreateBtn" type="button">Create account</button>
          </div>
        </div>
      </details>
      <div id="authStatus" style="font-size:12px;color:#b6bed3;margin-top:6px"></div>
      <div id="limitNote" class="pill" style="margin-top:6px"></div>
    </div>

    <label for="model">Model</label>
    <select id="model">
      <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
      <option value="gpt-4o">gpt-4o</option>
    </select>

    <label for="system">System instructions (optional)</label>
    <textarea id="system" placeholder="You are a concise, friendly assistant."></textarea>

    <label for="user">Your message</label>
    <textarea id="user" placeholder="Ask me anything..."></textarea>

    <button id="sendBtn" style="margin-top:8px">Send</button>
    <button id="clearBtn" type="button" style="margin-top:8px">Clear</button>
    <div id="status" style="font-size:12px;color:#b6bed3;margin-top:4px"></div>
    <div style="font-size:11px;color:#8391b3;margin-top:8px">⚠️ For production, move OpenAI calls to your server and never ship your API key in client code.</div>
  </section>

  <section>
    <div id="log" class="log"></div>
  </section>
</div>

<!-- Firebase Auth (v10) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAKkLg2hB7JiCgwg6sW-58BX4LRkpiVTxo",
    authDomain: "token-wizard.firebaseapp.com",
    projectId: "token-wizard",
    appId: "1:593641595767:web:933ac1eadc7ea285caf772"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const $ = (id) => document.getElementById(id);
  let isAuthenticated = false;
  let sentRequests = 0; // per-page-load guest counter
  const guestLimit = 1;

  function updateAuthUI(user){
    const statusEl = $("authStatus");
    const limitEl = $("limitNote");

    if(user){
      isAuthenticated = true;
      statusEl.textContent = `Signed in as ${user.email || user.displayName || "user"}. Unlimited messages unlocked.`;
      $("signOutBtn").style.display = "";
      $("googleBtn").style.display = "none";
      $("emailBox").style.display = "none";
      limitEl.textContent = "";
      $("sendBtn").disabled = false;
    }else{
      isAuthenticated = false;
      statusEl.textContent = "Guest mode: 1 free message. Sign in for unlimited.";
      $("signOutBtn").style.display = "none";
      $("googleBtn").style.display = "";
      $("emailBox").style.display = "";
      limitEl.textContent = `Remaining guest messages: ${Math.max(0, guestLimit - sentRequests)}`;
      if(sentRequests >= guestLimit){ $("sendBtn").disabled = true; }
    }
  }

  onAuthStateChanged(auth, (user) => updateAuthUI(user));

  $("googleBtn").onclick = async () => {
    try { await signInWithPopup(auth, provider); }
    catch (e) { alert(e.message || e); }
  };

  $("signOutBtn").onclick = async () => {
    try { await signOut(auth); sentRequests = 0; updateAuthUI(null); }
    catch (e) { alert(e.message || e); }
  };

  $("emailSignInBtn").onclick = async () => {
    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password){ alert("Enter email and password"); return; }
    try { await signInWithEmailAndPassword(auth, email, password); }
    catch (e) { alert(e.message || e); }
  };

  $("emailCreateBtn").onclick = async () => {
    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password){ alert("Enter email and password"); return; }
    try { await createUserWithEmailAndPassword(auth, email, password); }
    catch (e) { alert(e.message || e); }
  };

  // Expose gating to the non-module script
  window.__gating = {
    get isAuthenticated(){ return isAuthenticated; },
    get sentRequests(){ return sentRequests; },
    inc(){ sentRequests++; updateAuthUI(auth.currentUser); },
    get guestLimit(){ return guestLimit; }
  };
</script>

<script>
  // ⚠ Hardcoded API key — unsafe for public sites
  const API_KEY = "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";

  const $ = id => document.getElementById(id);
  const history = [];

  function addMessage(role, text){
    const div = document.createElement('div');
    div.className = 'msg ' + role; // fixed className
    div.textContent = text;
    $("log").appendChild(div);
    $("log").scrollTop = $("log").scrollHeight;
  }

  $("clearBtn").onclick = () => {
    history.length = 0;
    $("log").innerHTML = '';
    $("status").textContent = '';
    $("user").value = '';
    // Reset guest counter display
    const gate = window.__gating;
    if(!gate.isAuthenticated){
      $("sendBtn").disabled = gate.sentRequests >= gate.guestLimit;
      const note = document.getElementById('limitNote');
      if(note) note.textContent = `Remaining guest messages: ${Math.max(0, gate.guestLimit - gate.sentRequests)}`;
    }
  };

  $("sendBtn").onclick = async () => {
    const model = $("model").value.trim();
    const userMsg = $("user").value.trim();
    const sysMsg = $("system").value.trim();
    const gate = window.__gating;

    if(!userMsg){ alert('Please write a message.'); return; }

    // GATE: limit guests to 1 message
    if(!gate.isAuthenticated && gate.sentRequests >= gate.guestLimit){
      $("status").textContent = 'Guest limit reached — sign in for unlimited messages.';
      alert('Guest limit reached — please sign in for unlimited use.');
      return;
    }

    $("sendBtn").disabled = true;
    $("status").textContent = 'Sending...';
    addMessage('user', userMsg);

    const messages = [];
    if(sysMsg) messages.push({ role: 'system', content: sysMsg });
    for(const m of history) messages.push(m);
    messages.push({ role: 'user', content: userMsg });

    try {
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + API_KEY // fixed header
        },
        body: JSON.stringify({ model, messages, temperature: 0.7 })
      });
      if(!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content?.trim() || '(no content)';
      addMessage('assistant', reply);
      history.push({ role: 'user', content: userMsg }, { role: 'assistant', content: reply });
      $("user").value = '';
      $("status").textContent = 'Done';

      // Count guest messages only on success
      if(!gate.isAuthenticated){
        gate.inc();
        const note = document.getElementById('limitNote');
        if(note) note.textContent = `Remaining guest messages: ${Math.max(0, gate.guestLimit - gate.sentRequests)}`;
      }
    } catch (err){
      addMessage('assistant', '⚠️ Error: ' + (err.message || err));
      $("status").textContent = 'Failed';
    } finally {
      // Disable send button if guest limit reached
      const gate2 = window.__gating;
      if(!gate2.isAuthenticated && gate2.sentRequests >= gate2.guestLimit){
        $("sendBtn").disabled = true;
      } else {
        $("sendBtn").disabled = false;
      }
    }
  };
</script>
</body>
</html>


