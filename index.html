<!doctype html>
<html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LLMLingua Chat</title>
<style>
body{font-family:sans-serif;background:#0b1020;color:#e9ecf1;margin:0}
.wrap{max-width:980px;margin:auto;padding:16px;display:grid;grid-template-columns:320px 1fr;gap:12px}
@media(max-width:900px){.wrap{grid-template-columns:1fr}}
textarea,select,button,input{width:100%;border-radius:8px;border:1px solid #444;background:#0e1530;color:#e9ecf1;padding:10px}
textarea{min-height:100px;resize:vertical}
.log{border:1px solid #333;border-radius:8px;padding:10px;max-height:60vh;overflow:auto;white-space:pre-wrap}
.msg{padding:8px;margin:6px 0;border-radius:8px}
.user{background:#0f1a3f}
.assistant{background:#1a1f3f}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #333;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
.btn{cursor:pointer}
.btn-primary{background:#4a7dff;border-color:#4a7dff;color:white}
.hint{font-size:12px;color:#b6bed3}
details{border:1px solid #333;border-radius:8px;padding:8px;background:#0e1530}
details[open]{box-shadow:0 0 0 2px rgba(74,125,255,.2) inset}
summary{cursor:pointer;list-style:none}
summary::-webkit-details-marker{display:none}
kbd{background:#1a1f3f;border:1px solid #333;border-radius:4px;padding:0 6px;font-size:12px}
.copy{font-size:12px;border-radius:6px;border:1px solid #333;background:#162045;color:#e9ecf1;padding:4px 8px;cursor:pointer}
.copy:active{transform:scale(0.98)}
</style>
<body>
<h1 style="text-align:center;margin:16px 0">Chat (with LLMLingua)</h1>
<div class="wrap">
  <section>
    <label>Model</label>
    <select id="model">
      <option value="gpt-4o-mini">gpt-4o-mini</option>
      <option value="gpt-4o">gpt-4o</option>
    </select>

    <label>System instructions (optional)</label>
    <textarea id="system" placeholder="You are a concise, friendly assistant."></textarea>

    <label>Your message</label>
    <textarea id="user" placeholder="Ask me anything..."></textarea>

    <div class="row" style="margin-top:8px">
      <label class="pill"><input type="checkbox" id="useCompression" checked/> Enable LLMLingua</label>
      <label class="pill">Rate <input id="rate" type="number" step="0.05" min="0.1" max="1.0" value="0.5" style="width:80px"/></label>
      <label class="pill">Min chars <input id="minChars" type="number" step="50" min="0" value="400" style="width:90px"/></label>
    </div>

    <div class="row" style="margin-top:6px">
      <label class="pill" title="When on, the server returns the compressed text"><input type="checkbox" id="showCompressed"/> Show compressed prompt</label>
    </div>

    <div class="row">
      <button id="sendBtn" class="btn btn-primary" style="margin-top:8px">Send</button>
      <button id="clearBtn" class="btn" type="button" style="margin-top:8px">Clear</button>
    </div>
    <div id="status" class="hint" style="margin-top:6px"></div>
    <p class="hint">Your API key stays on the server. This page calls <code>/api/chat</code>.</p>
  </section>

  <section>
    <div id="log" class="log" aria-live="polite"></div>

    <details id="compressedBox" style="margin-top:10px" hidden>
      <summary><strong>Compressed prompt</strong> <span id="ratioTag" class="hint"></span></summary>
      <div class="row" style="justify-content:flex-end;margin:6px 0">
        <button id="copyBtn" class="copy" type="button">Copy</button>
      </div>
      <pre id="compressedText" style="white-space:pre-wrap;"></pre>
    </details>
  </section>
</div>

<script>
const historyMsgs = [];
function addMessage(role, text){
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  div.textContent = text;
  document.getElementById('log').appendChild(div);
  document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
}
function setCompressedUI(visible, text, info){
  const box = document.getElementById('compressedBox');
  const pre = document.getElementById('compressedText');
  const ratioTag = document.getElementById('ratioTag');
  if(!visible){
    box.hidden = true;
    pre.textContent = '';
    ratioTag.textContent = '';
    return;
  }
  pre.textContent = text || '(empty)';
  ratioTag.textContent = info ? '• ' + info : '';
  box.hidden = false;
}

document.getElementById('clearBtn').onclick = () => {
  historyMsgs.length = 0;
  document.getElementById('log').innerHTML='';
  document.getElementById('status').textContent='';
  document.getElementById('user').value='';
  setCompressedUI(false);
};

document.getElementById('copyBtn').onclick = async () => {
  const text = document.getElementById('compressedText').textContent;
  try{
    await navigator.clipboard.writeText(text);
    document.getElementById('copyBtn').textContent = 'Copied';
    setTimeout(()=>document.getElementById('copyBtn').textContent='Copy', 1000);
  }catch{}
};

document.getElementById('sendBtn').onclick = async () => {
  const model = document.getElementById('model').value.trim();
  const sysMsg = document.getElementById('system').value.trim();
  const userMsg = document.getElementById('user').value.trim();
  const useCompression = document.getElementById('useCompression').checked;
  const rate = parseFloat(document.getElementById('rate').value || '0.5');
  const minChars = parseInt(document.getElementById('minChars').value || '400', 10);
  const debug = document.getElementById('showCompressed').checked;

  if(!userMsg){ alert('Please write a message.'); return; }

  document.getElementById('sendBtn').disabled = true;
  document.getElementById('status').textContent = 'Sending...';
  addMessage('user', userMsg);

  const messages = [];
  if(sysMsg) messages.push({ role: 'system', content: sysMsg });
  for(const m of historyMsgs) messages.push(m);
  messages.push({ role: 'user', content: userMsg });

  try{
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model, messages, compress: useCompression, rate, min_chars: minChars, debug })
    });
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    const reply = data.reply || '(no content)';
    addMessage('assistant', reply);
    historyMsgs.push({ role: 'user', content: userMsg }, { role: 'assistant', content: reply });
    document.getElementById('user').value='';
    const info = data.compressed ? ('Compressed: ' + (data.compression_info||'')) : 'Not compressed';
    document.getElementById('status').textContent = info;

    // Show compressed prompt if requested and available
    if (debug && data.compressed && data.compressed_prompt){
      setCompressedUI(true, data.compressed_prompt, data.compression_info||'');
    }else{
      setCompressedUI(false);
    }
  }catch(err){
    addMessage('assistant', '⚠️ ' + (err.message || err));
    document.getElementById('status').textContent = 'Failed';
    setCompressedUI(false);
  }finally{
    document.getElementById('sendBtn').disabled = false;
  }
};
</script>
</body>
</html>
